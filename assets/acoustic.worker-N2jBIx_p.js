(function(){"use strict";var i=(t=>(t[t.NONE=0]="NONE",t[t.WOOD=1]="WOOD",t[t.BRICK=2]="BRICK",t[t.STONE=3]="STONE",t[t.METAL=4]="METAL",t[t.INDESTRUCTIBLE=5]="INDESTRUCTIBLE",t))(i||{});const b={[i.NONE]:{absorption:0,cutoff:2e4,reflection:.1},[i.WOOD]:{absorption:.65,cutoff:2e3,reflection:.15},[i.BRICK]:{absorption:.35,cutoff:6e3,reflection:.5},[i.STONE]:{absorption:.2,cutoff:1e4,reflection:.7},[i.METAL]:{absorption:.05,cutoff:18e3,reflection:.95},[i.INDESTRUCTIBLE]:{absorption:.1,cutoff:15e3,reflection:.8}};self.onmessage=t=>{if(t.data.type==="propagate"){const{source:A,listeners:C,grid:D,width:o,height:r,tileSize:e,requestId:L}=t.data,B=Math.max(0,Math.min(o-1,Math.floor(A.x/e))),M=Math.max(0,Math.min(r-1,Math.floor(A.y/e))),w={},d=new Float32Array(o*r).fill(1/0),N=new Int32Array(o*r*2).fill(-1),u=new Float32Array(o*r).fill(0),O=new Float32Array(o*r).fill(2e4),x=M*o+B;d[x]=0,u[x]=A.volume,O[x]=2e4;const h=[x],g=new Uint8Array(o*r);for(;h.length>0;){let l=0;for(let s=1;s<h.length;s++)u[h[s]]>u[h[l]]&&(l=s);const n=h.splice(l,1)[0];if(g[n])continue;g[n]=1;const a=n%o,c=Math.floor(n/o),I=u[n],p=O[n];if(!(I<.5))for(let s=-1;s<=1;s++)for(let E=-1;E<=1;E++){if(E===0&&s===0)continue;const m=a+E,R=c+s;if(m<0||m>=o||R<0||R>=r)continue;const f=R*o+m;if(g[f])continue;const v=Math.sqrt(E*E+s*s),U=D[f],y=b[U]||b[i.NONE];let S=I*(1-y.absorption);S*=1/(1+v*.1),S>u[f]&&(u[f]=S,d[f]=d[n]+v,O[f]=Math.min(p,y.cutoff),N[f*2]=a,N[f*2+1]=c,h.push(f))}}for(const l of C){const n=Math.floor(l.x/e),a=Math.floor(l.y/e);if(n<0||n>=o||a<0||a>=r)continue;const c=a*o+n;if(u[c]>1){const I=N[c*2],p=N[c*2+1];w[l.id]={volume:u[c],distance:d[c]*e,cutoff:O[c],apparentSource:{x:(I===-1?n:I)*e+e/2,y:(p===-1?a:p)*e+e/2}}}}self.postMessage({type:"propagationResult",requestId:L,results:w})}}})();
