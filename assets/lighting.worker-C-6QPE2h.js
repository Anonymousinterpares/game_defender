(function(){"use strict";class _{static calculateVisibility(s,i,l=1e3,y=null,o=null){const a=[],u=[],h=t=>{for(;t<-Math.PI;)t+=Math.PI*2;for(;t>Math.PI;)t-=Math.PI*2;return t},x=t=>{if(y===null||o===null)return!0;const c=h(t),e=h(y),n=h(o);return e<n?c>=e&&c<=n:c>=e||c<=n},M=l*l;for(const t of i){const c=(t.a.x-s.x)**2+(t.a.y-s.y)**2,e=(t.b.x-s.x)**2+(t.b.y-s.y)**2;if(c>M&&e>M)continue;t.minX=Math.min(t.a.x,t.b.x),t.maxX=Math.max(t.a.x,t.b.x),t.minY=Math.min(t.a.y,t.b.y),t.maxY=Math.max(t.a.y,t.b.y),u.push(t);const n=Math.atan2(t.a.y-s.y,t.a.x-s.x),r=Math.atan2(t.b.y-s.y,t.b.x-s.x);x(n)&&a.push(n,n-1e-4,n+1e-4),x(r)&&a.push(r,r-1e-4,r+1e-4)}if(y!==null&&a.push(y),o!==null&&a.push(o),a.length===0){if(y!==null)return[];a.push(0,Math.PI/2,Math.PI,-Math.PI/2)}const p=Array.from(new Set(a)).sort((t,c)=>t-c),f=[];for(const t of p){const c=Math.cos(t),e=Math.sin(t),n={a:s,b:{x:s.x+c*l,y:s.y+e*l}};let r=1,I={x:n.b.x,y:n.b.y};for(const b of u){const P=Math.min(n.a.x,n.b.x),X=Math.max(n.a.x,n.b.x),Y=Math.min(n.a.y,n.b.y),S=Math.max(n.a.y,n.b.y);if(b.maxX<P||b.minX>X||b.maxY<Y||b.minY>S)continue;const m=this.getIntersection(n,b);m&&m.t1<r&&(r=m.t1,I=m.p)}f.push(I)}return f}static getIntersection(s,i){const l=s.a.x,y=s.a.y,o=s.b.x-s.a.x,a=s.b.y-s.a.y,u=i.a.x,h=i.a.y,x=i.b.x-i.a.x,M=i.b.y-i.a.y,p=Math.sqrt(o*o+a*a),f=Math.sqrt(x*x+M*M);if(p===0||f===0)return null;const t=M*o-x*a;if(Math.abs(t)<1e-4)return null;const c=(o*(h-y)+a*(l-u))/t,e=(u+x*c-l)/o;return e>=0&&e<=1&&c>=0&&c<=1?{p:{x:l+o*e,y:y+a*e},t1:e}:null}}self.onmessage=d=>{const{type:s,data:i}=d.data;if(s==="calculateVisibility"){const{id:l,origin:y,segments:o,radius:a,startAngle:u,endAngle:h}=i,x=_.calculateVisibility(y,o,a,u,h);self.postMessage({type:"visibilityResult",data:{id:l,polygon:x}})}}})();
