(function(){"use strict";var g=(i=>(i[i.STANDARD=0]="STANDARD",i[i.SHOCKWAVE=1]="SHOCKWAVE",i[i.FLASH=2]="FLASH",i[i.MOLTEN=3]="MOLTEN",i))(g||{});const v=1,p=2;let h=null,z=0,E=0,L=0,S=null,m=!0;self.onmessage=i=>{const{type:f,data:a}=i.data;if(f==="init"){const{buffer:r,worldData:s,role:o}=a;o!==void 0&&(m=o==="host"||o==="single");const e=1e4;let t=0;const n=l=>{const d=new Float32Array(r,t,l);return t+=l*4,d},u=l=>{const d=new Uint8Array(r,t,l);return t+=l,t=t+3&-4,d},y=l=>{const d=new Uint32Array(r,t,l);return t+=l*4,d};h={x:n(e),y:n(e),z:n(e),prevX:n(e),prevY:n(e),prevZ:n(e),vx:n(e),vy:n(e),vz:n(e),life:n(e),maxLife:n(e),radius:n(e),startRadius:n(e),type:u(e),flags:u(e),colorIdx:y(e)},s&&(z=s.width,E=s.height,L=s.tileSize,S=new Uint8Array(s.tilesBuffer))}else if(f==="update"){if(!h)return;const{dt:r,player:s,enemies:o}=a;N(r,s,o),self.postMessage({type:"updated"})}};function M(i,f){if(!S)return!1;const a=Math.floor(i/L),r=Math.floor(f/L);return a<0||a>=z||r<0||r>=E?!0:S[r*z+a]!==0}function N(i,f,a){if(!h)return;const r=1e4,s=h,o=[],e=[];for(let t=0;t<r;t++){if(!(s.flags[t]&v))continue;s.prevX[t]=s.x[t],s.prevY[t]=s.y[t],s.prevZ[t]=s.z[t];const n=s.type[t];if(n===g.STANDARD||n===g.MOLTEN){const u=s.x[t]+s.vx[t]*i,y=s.y[t]+s.vy[t]*i;if(s.flags[t]&p&&M(u,y)?(s.vx[t]=0,s.vy[t]=0,s.life[t]*=.5):n===g.MOLTEN&&M(u,y)?(s.vx[t]*=-.3,s.vy[t]*=-.3):(s.x[t]=u,s.y[t]=y),n===g.MOLTEN){if(s.vz[t]+=80*i,s.z[t]+=s.vz[t]*i,s.vx[t]*=.995,s.vy[t]*=.995,s.z[t]>0&&s.vz[t]>0&&(s.z[t]!==0&&m&&e.push({x:s.x[t],y:s.y[t],intensity:.6,radius:20}),s.z[t]=0,s.vz[t]=0,s.vx[t]=0,s.vy[t]=0),s.z[t]<-2){if(f&&f.active){const c=f.x-s.x[t],x=f.y-s.y[t],A=f.radius+s.radius[t];c*c+x*x<A*A&&(o.push({targetIdx:-1,damage:5}),s.flags[t]&=~v)}if(s.flags[t]&v)for(let c=0;c<a.length;c++){const x=a[c],A=x.x-s.x[t],w=x.y-s.y[t],F=x.radius+s.radius[t];if(A*A+w*w<F*F){o.push({targetIdx:c,damage:5}),s.flags[t]&=~v;break}}}}else s.vx[t]*=.95,s.vy[t]*=.95}if(s.life[t]-=i,s.life[t]<=0&&(s.flags[t]&=~v),s.flags[t]&v){const u=s.life[t]/s.maxLife[t];s.flags[t]&p&&(s.radius[t]=s.startRadius[t]+(1-u)*10)}}(o.length>0||e.length>0)&&self.postMessage({type:"events",data:{damageEvents:o,heatEvents:e}})}})();
