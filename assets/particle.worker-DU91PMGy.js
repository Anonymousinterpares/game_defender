(function(){"use strict";var g=(n=>(n[n.STANDARD=0]="STANDARD",n[n.SHOCKWAVE=1]="SHOCKWAVE",n[n.FLASH=2]="FLASH",n[n.MOLTEN=3]="MOLTEN",n))(g||{});const v=1,S=2;let A=null,h=0,p=0,z=0,L=null;self.onmessage=n=>{const{type:a,data:o}=n.data;if(a==="init"){const{buffer:r,worldData:s}=o,e=1e4;let i=0;const t=f=>{const d=new Float32Array(r,i,f);return i+=f*4,d},l=f=>{const d=new Uint8Array(r,i,f);return i+=f,i=i+3&-4,d},u=f=>{const d=new Uint32Array(r,i,f);return i+=f*4,d};A={x:t(e),y:t(e),z:t(e),prevX:t(e),prevY:t(e),prevZ:t(e),vx:t(e),vy:t(e),vz:t(e),life:t(e),maxLife:t(e),radius:t(e),startRadius:t(e),type:l(e),flags:l(e),colorIdx:u(e)},s&&(h=s.width,p=s.height,z=s.tileSize,L=new Uint8Array(s.tilesBuffer))}else if(a==="update"){if(!A)return;const{dt:r,player:s,enemies:e}=o;w(r,s,e),self.postMessage({type:"updated"})}};function E(n,a){if(!L)return!1;const o=Math.floor(n/z),r=Math.floor(a/z);return o<0||o>=h||r<0||r>=p?!0:L[r*h+o]!==0}function w(n,a,o){if(!A)return;const r=1e4,s=A,e=[],i=[];for(let t=0;t<r;t++){if(!(s.flags[t]&v))continue;s.prevX[t]=s.x[t],s.prevY[t]=s.y[t],s.prevZ[t]=s.z[t];const l=s.type[t];if(l===g.STANDARD||l===g.MOLTEN){const u=s.x[t]+s.vx[t]*n,f=s.y[t]+s.vy[t]*n;if(s.flags[t]&S&&E(u,f)?(s.vx[t]=0,s.vy[t]=0,s.life[t]*=.5):l===g.MOLTEN&&E(u,f)?(s.vx[t]*=-.3,s.vy[t]*=-.3):(s.x[t]=u,s.y[t]=f),l===g.MOLTEN){if(s.vz[t]+=80*n,s.z[t]+=s.vz[t]*n,s.vx[t]*=.995,s.vy[t]*=.995,s.z[t]>0&&s.vz[t]>0&&(s.z[t]!==0&&i.push({x:s.x[t],y:s.y[t],intensity:.6,radius:20}),s.z[t]=0,s.vz[t]=0,s.vx[t]=0,s.vy[t]=0),s.z[t]<-2){if(a&&a.active){const c=a.x-s.x[t],x=a.y-s.y[t],y=a.radius+s.radius[t];c*c+x*x<y*y&&(e.push({targetIdx:-1,damage:5}),s.flags[t]&=~v)}if(s.flags[t]&v)for(let c=0;c<o.length;c++){const x=o[c],y=x.x-s.x[t],m=x.y-s.y[t],M=x.radius+s.radius[t];if(y*y+m*m<M*M){e.push({targetIdx:c,damage:5}),s.flags[t]&=~v;break}}}}else s.vx[t]*=.95,s.vy[t]*=.95}if(s.life[t]-=n,s.life[t]<=0&&(s.flags[t]&=~v),s.flags[t]&v){const u=s.life[t]/s.maxLife[t];s.flags[t]&S&&(s.radius[t]=s.startRadius[t]+(1-u)*10)}}(e.length>0||i.length>0)&&self.postMessage({type:"events",data:{damageEvents:e,heatEvents:i}})}})();
