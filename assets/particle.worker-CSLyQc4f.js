(function(){"use strict";var v=(i=>(i[i.STANDARD=0]="STANDARD",i[i.SHOCKWAVE=1]="SHOCKWAVE",i[i.FLASH=2]="FLASH",i[i.MOLTEN=3]="MOLTEN",i[i.SMOKE=4]="SMOKE",i))(v||{});const x=1,L=2;let S=null,z=0,m=0,E=0,h=null,w=!0;self.onmessage=i=>{const{type:l,data:c}=i.data;if(l==="init"){const{buffer:n,worldData:u,role:t}=c;t!==void 0&&(w=t==="host"||t==="single");const e=1e4;let r=0;const o=f=>{const a=new Float32Array(n,r,f);return r+=f*4,a},M=f=>{const a=new Uint8Array(n,r,f);return r+=f,r=r+3&-4,a},s=f=>{const a=new Uint32Array(n,r,f);return r+=f*4,a};S={x:o(e),y:o(e),z:o(e),prevX:o(e),prevY:o(e),prevZ:o(e),vx:o(e),vy:o(e),vz:o(e),life:o(e),maxLife:o(e),radius:o(e),startRadius:o(e),type:M(e),flags:M(e),colorIdx:s(e)},u&&(z=u.width,m=u.height,E=u.tileSize,h=new Uint8Array(u.tilesBuffer))}else if(l==="update"){if(!S)return;const{dt:n,player:u,enemies:t,weather:e}=c;N(n,u,t,e),self.postMessage({type:"updated"})}};function p(i,l){if(!h)return!1;const c=Math.floor(i/E),n=Math.floor(l/E);return c<0||c>=z||n<0||n>=m?!0:h[n*z+c]!==0}function N(i,l,c,n){if(!S)return;const u=1e4,t=S,e=[],r=[],o=n?n.windDir.x*n.windSpeed:0,M=n?n.windDir.y*n.windSpeed:0;for(let s=0;s<u;s++){if(!(t.flags[s]&x))continue;t.prevX[s]=t.x[s],t.prevY[s]=t.y[s],t.prevZ[s]=t.z[s];const f=t.type[s];if(f===v.SMOKE){const y=Date.now()*.001+s,D=Math.sin(y*2)*10,O=Math.cos(y*1.5)*5;t.vx[s]+=(o*20+D-t.vx[s]*.5)*i,t.vy[s]+=(M*20+-15+O-t.vy[s]*.5)*i,t.x[s]+=t.vx[s]*i,t.y[s]+=t.vy[s]*i;const d=t.life[s]/t.maxLife[s];t.radius[s]=t.startRadius[s]+(1-d)*(t.startRadius[s]*2)}else if(f===v.STANDARD||f===v.MOLTEN){const a=t.x[s]+t.vx[s]*i,y=t.y[s]+t.vy[s]*i;if(t.flags[s]&L&&p(a,y)?(t.vx[s]=0,t.vy[s]=0,t.life[s]*=.5):f===v.MOLTEN&&p(a,y)?(t.vx[s]*=-.3,t.vy[s]*=-.3):(t.x[s]=a,t.y[s]=y),f===v.MOLTEN){if(t.vz[s]+=80*i,t.z[s]+=t.vz[s]*i,t.vx[s]*=.995,t.vy[s]*=.995,t.z[s]>0&&t.vz[s]>0&&(t.z[s]!==0&&w&&r.push({x:t.x[s],y:t.y[s],intensity:.6,radius:20}),t.z[s]=0,t.vz[s]=0,t.vx[s]=0,t.vy[s]=0),t.z[s]<-2){if(l&&l.active){const d=l.x-t.x[s],g=l.y-t.y[s],A=l.radius+t.radius[s];d*d+g*g<A*A&&(e.push({targetIdx:-1,damage:5}),t.flags[s]&=~x)}if(t.flags[s]&x)for(let d=0;d<c.length;d++){const g=c[d],A=g.x-t.x[s],R=g.y-t.y[s],F=g.radius+t.radius[s];if(A*A+R*R<F*F){e.push({targetIdx:d,damage:5}),t.flags[s]&=~x;break}}}}else t.vx[s]*=.95,t.vy[s]*=.95}if(t.life[s]-=i,t.life[s]<=0&&(t.flags[s]&=~x),t.flags[s]&x){const a=t.life[s]/t.maxLife[s];t.flags[s]&L&&(t.radius[s]=t.startRadius[s]+(1-a)*10)}}(e.length>0||r.length>0)&&self.postMessage({type:"events",data:{damageEvents:e,heatEvents:r}})}})();
