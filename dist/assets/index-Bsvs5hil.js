(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))e(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&e(o)}).observe(document,{childList:!0,subtree:!0});function i(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(s){if(s.ep)return;s.ep=!0;const n=i(s);fetch(s.href,n)}})();class y{static instance;audioCtx=null;isMuted=!1;sounds=new Map;constructor(){}static getInstance(){return y.instance||(y.instance=new y),y.instance}init(){this.audioCtx||(this.audioCtx=new(window.AudioContext||window.webkitAudioContext))}toggleMute(){return this.isMuted=!this.isMuted,this.isMuted&&this.audioCtx?this.audioCtx.suspend():this.audioCtx&&this.audioCtx.resume(),this.isMuted}getMuted(){return this.isMuted}async loadSound(t,i){this.audioCtx||this.init();try{const s=await(await fetch(i)).arrayBuffer(),n=await this.audioCtx.decodeAudioData(s);this.sounds.set(t,n)}catch{console.warn(`Failed to load sound ${t} from ${i}. Using fallback.`)}}playSound(t){if(this.isMuted||!this.audioCtx)return;this.audioCtx.state==="suspended"&&this.audioCtx.resume();const i=this.sounds.get(t);if(i){const e=this.audioCtx.createBufferSource();e.buffer=i,e.connect(this.audioCtx.destination),e.start()}else t==="ping"&&this.synthesizePing()}synthesizePing(){if(!this.audioCtx)return;const t=this.audioCtx.createOscillator(),i=this.audioCtx.createGain();t.type="sine",t.frequency.setValueAtTime(800,this.audioCtx.currentTime),t.frequency.exponentialRampToValueAtTime(400,this.audioCtx.currentTime+.1),i.gain.setValueAtTime(.1,this.audioCtx.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.audioCtx.currentTime+.1),t.connect(i),i.connect(this.audioCtx.destination),t.start(),t.stop(this.audioCtx.currentTime+.1)}}class M{constructor(t){this.sceneManager=t}container=null;onEnter(){console.log("Entering Main Menu"),this.createUI(),y.getInstance().init()}onExit(){this.container&&(this.container.remove(),this.container=null)}update(t){}render(t){t.fillStyle="#050505",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.strokeStyle="#003300",t.lineWidth=1;const i=50;for(let e=0;e<t.canvas.width;e+=i)t.beginPath(),t.moveTo(e,0),t.lineTo(e,t.canvas.height),t.stroke();for(let e=0;e<t.canvas.height;e+=i)t.beginPath(),t.moveTo(0,e),t.lineTo(t.canvas.width,e),t.stroke()}createUI(){const t=document.getElementById("ui-layer");if(!t)return;this.container=document.createElement("div"),this.container.className="ui-panel";const e=y.getInstance().getMuted()?"ðŸ”‡":"ðŸ”Š";this.container.innerHTML=`
      <div style="position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 24px;" id="btn-mute">${e}</div>
      <h1 style="color: #00ff00; text-align: center; font-size: 2em; margin-bottom: 30px;">NEON ROGUE</h1>
      <button id="btn-start">Start Game</button>
      <button id="btn-settings">Settings</button>
    `,t.appendChild(this.container),document.getElementById("btn-start")?.addEventListener("click",()=>{this.sceneManager.switchScene("gameplay")}),document.getElementById("btn-settings")?.addEventListener("click",()=>{this.sceneManager.switchScene("settings")}),document.getElementById("btn-mute")?.addEventListener("click",s=>{const n=y.getInstance().toggleMute();s.target.textContent=n?"ðŸ”‡":"ðŸ”Š"})}}const b={World:{width:{value:50,type:"number",min:10,max:5e3,step:10,description:"Map Width (Tiles)"},height:{value:50,type:"number",min:10,max:5e3,step:10,description:"Map Height (Tiles)"},tileSize:{value:32,type:"number",min:16,max:128,step:1,description:"Tile Size (Pixels)"},renderDistance:{value:50,type:"number",min:10,max:100,step:1,description:"Render Distance (Units)"}},Player:{baseSpeed:{value:5,type:"number",min:1,max:50,step:.5,description:"Movement Speed (Units/sec)"},turnSpeed:{value:3,type:"number",min:.1,max:10,step:.1,description:"Turn Speed (Rad/sec)"},maxHealth:{value:100,type:"number",min:1,max:1e3,step:10,description:"Base Health"},bodyLength:{value:2,type:"number",min:1,max:20,step:1,description:"Additional Body Segments"},shootCooldown:{value:.2,type:"number",min:.05,max:1,step:.01,description:"Weapon Fire Rate"}},Upgrades:{hullRepairCost:{value:50,type:"number",description:"Repair Cost"},speedUpgradeCost:{value:100,type:"number",description:"Engine Tune Cost"},fireRateUpgradeCost:{value:150,type:"number",description:"Weapon Upgrade Cost"},slotUpgradeCost:{value:300,type:"number",description:"New Slot Cost"},turretUpgradeCost:{value:200,type:"number",description:"Turret Cost"},shieldUpgradeCost:{value:250,type:"number",description:"Shield Cost"}},Physics:{friction:{value:.9,type:"number",min:.1,max:1,step:.01,description:"Movement Friction"},collisionPrecision:{value:.5,type:"number",min:.1,max:1,step:.1,description:"Collision Check Step"}},Debug:{showHitboxes:{value:!1,type:"boolean",description:"Show Hitboxes"},showGrid:{value:!0,type:"boolean",description:"Show Map Grid"},fpsCounter:{value:!0,type:"boolean",description:"Show FPS"}},Keybindings:{openDock:{value:"KeyP",type:"string",description:"Open Dock/Shop"}}};class r{static instance;constructor(){}static getInstance(){return r.instance||(r.instance=new r),r.instance}get(t,i){return b[t][i].value}set(t,i,e){b[t]&&b[t][i]&&(b[t][i].value=e,console.log(`Config Updated: [${t}.${i}] = ${e}`))}getSchema(){return b}}class x{constructor(t){this.sceneManager=t}container=null;onEnter(){this.createUI()}onExit(){this.container&&(this.container.remove(),this.container=null)}update(t){}render(t){t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(0,0,t.canvas.width,t.canvas.height)}createUI(){const t=document.getElementById("ui-layer");if(!t)return;this.container=document.createElement("div"),this.container.className="ui-panel",this.container.style.width="600px";let i="<h2>Settings</h2>";i+=`
      <div style="background: rgba(0,0,0,0.3); border: 1px solid var(--steam-brass); padding: 15px; margin-bottom: 20px; font-size: 0.8em; color: var(--steam-gold);">
        <h4 style="margin-top:0; text-decoration: underline;">OPERATIONAL CONTROLS:</h4>
        <ul style="list-style: none; padding: 0;">
            <li><b>MOUSE:</b> Aim / Steering Direction</li>
            <li><b>[W]:</b> Throttle Forward</li>
            <li><b>[S]:</b> Reverse Gear</li>
            <li><b>[SPACE]:</b> Fire Primary Cannon</li>
            <li><b>[P]:</b> Open Engineering Dock</li>
            <li><b>[ESC]:</b> Return to Main Menu</li>
        </ul>
      </div>
    `,i+=`
      <div class="control-group" style="border: 1px dashed #666; padding: 10px; margin-bottom: 20px;">
        <label>Game Difficulty (Coming Soon)</label>
        <select disabled style="width: 100%; background: #222; color: #666; border: 1px solid #444;">
          <option>Normal</option>
          <option>Hard</option>
          <option>Nightmare</option>
        </select>
      </div>
    `;const e=r.getInstance().getSchema();for(const[s,n]of Object.entries(e)){i+=`<h3 style="color: var(--steam-brass); border-bottom: 1px solid #333; margin-top: 20px;">${s}</h3>`;for(const[o,a]of Object.entries(n))i+=this.generateControl(s,o,a)}i+='<button id="btn-back">BACK TO MENU</button>',this.container.innerHTML=i,t.appendChild(this.container),this.bindEvents(e),document.getElementById("btn-back")?.addEventListener("click",()=>{this.sceneManager.switchScene("menu")})}generateControl(t,i,e){const s=`cfg-${t}-${i}`;return e.type==="number"&&e.min!==void 0&&e.max!==void 0?`
        <div class="control-group">
          <label for="${s}">${e.description}</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="range" id="${s}" min="${e.min}" max="${e.max}" step="${e.step||1}" value="${e.value}">
            <span id="${s}-val" class="value-display">${e.value}</span>
          </div>
        </div>
      `:e.type==="boolean"?`
        <div class="control-group">
          <label style="display: flex; justify-content: space-between; align-items: center;">
            ${e.description}
            <input type="checkbox" id="${s}" ${e.value?"checked":""}>
          </label>
        </div>
      `:e.type==="string"?`
            <div class="control-group">
                <label for="${s}">${e.description}</label>
                <input type="text" id="${s}" value="${e.value}" style="background: #000; color: #0f0; border: 1px solid #333; padding: 5px;">
            </div>
        `:""}bindEvents(t){for(const[i,e]of Object.entries(t))for(const[s,n]of Object.entries(e)){const o=n,a=`cfg-${i}-${s}`,c=document.getElementById(a);if(c)if(o.type==="number"){const d=document.getElementById(`${a}-val`);c.addEventListener("input",h=>{const l=parseFloat(h.target.value);r.getInstance().set(i,s,l),d&&(d.textContent=l.toString())})}else o.type==="boolean"?c.addEventListener("change",d=>{const h=d.target.checked;r.getInstance().set(i,s,h)}):o.type==="string"&&c.addEventListener("change",d=>{const h=d.target.value;r.getInstance().set(i,s,h)})}}}class E{width;height;tileSize;tiles;constructor(){this.width=r.getInstance().get("World","width"),this.height=r.getInstance().get("World","height"),this.tileSize=r.getInstance().get("World","tileSize"),this.tiles=[],this.generate()}generate(){for(let t=0;t<this.height;t++){const i=[];for(let e=0;e<this.width;e++)e===0||e===this.width-1||t===0||t===this.height-1?i.push(1):i.push(Math.random()<.05?1:0);this.tiles.push(i)}}getWidthPixels(){return this.width*this.tileSize}getHeightPixels(){return this.height*this.tileSize}render(t,i,e){const s=t.canvas.width,n=t.canvas.height,o=Math.floor(i/this.tileSize),a=o+s/this.tileSize+1,c=Math.floor(e/this.tileSize),d=c+n/this.tileSize+1;t.strokeStyle="#2c241b",t.lineWidth=1;for(let h=c;h<=d;h++)if(!(h<0||h>=this.height))for(let l=o;l<=a;l++){if(l<0||l>=this.width)continue;const p=this.tiles[h][l],g=l*this.tileSize,f=h*this.tileSize;p===1&&(t.fillStyle="#2a2a2a",t.fillRect(g,f,this.tileSize,this.tileSize),t.strokeStyle="#554433",t.lineWidth=2,t.strokeRect(g+2,f+2,this.tileSize-4,this.tileSize-4),t.beginPath(),t.moveTo(g,f),t.lineTo(g+this.tileSize,f+this.tileSize),t.stroke())}}isWall(t,i){const e=Math.floor(t/this.tileSize),s=Math.floor(i/this.tileSize);return e<0||e>=this.width||s<0||s>=this.height?!0:this.tiles[s][e]===1}resolveCollision(t,i,e){return this.isWall(t,i)?{x:t,y:i,collided:!0}:{x:t,y:i,collided:!1}}}class m{id=Math.random().toString(36).substr(2,9);x=0;y=0;vx=0;vy=0;radius=10;isStatic=!1;color="#fff";rotation=0;constructor(t,i){this.x=t,this.y=i}}class S extends m{segments=[];upgrades=new Map;input;baseSpeedStat=0;speed=0;turnSpeed=0;bodyLength=2;segmentSpacing=35;constructor(t,i,e){super(t,i),this.input=e,this.color="#cfaa6e",this.radius=15,this.refreshConfig(),this.initSegments(t,i)}initSegments(t,i){this.segments=[];for(let e=0;e<this.bodyLength;e++){const s=new class extends m{constructor(n,o,a){super(n,o),this.radius=a}update(n){}render(n){}}(t-(e+1)*this.segmentSpacing,i,this.radius);this.segments.push(s)}}addSlot(){this.bodyLength++;const t=this.segments[this.segments.length-1]||this,i=new class extends m{constructor(e,s,n){super(e,s),this.radius=n}update(e){}render(e){}}(t.x,t.y,this.radius);this.segments.push(i),this.calculateSpeed()}refreshConfig(){this.baseSpeedStat=r.getInstance().get("Player","baseSpeed"),this.turnSpeed=r.getInstance().get("Player","turnSpeed"),this.segments.length===0&&(this.bodyLength=r.getInstance().get("Player","bodyLength")),this.calculateSpeed()}calculateSpeed(){const t=Math.max(.5,1-(this.bodyLength-2)*.05);this.speed=this.baseSpeedStat*20*t}getAllBodies(){return[this,...this.segments]}update(t,i=[],e=()=>{}){const s=window.innerWidth/2,n=window.innerHeight/2,o=this.input.mouseX-s,a=this.input.mouseY-n;if(Math.sqrt(o*o+a*a)>20){let l=Math.atan2(a,o)-this.rotation;for(;l<-Math.PI;)l+=Math.PI*2;for(;l>Math.PI;)l-=Math.PI*2;this.rotation+=l*10*t}let d=0;this.input.isKeyDown("KeyW")?d=this.speed:this.input.isKeyDown("KeyS")&&(d=-this.speed*.6),d===0?(this.vx=0,this.vy=0):(this.vx=Math.cos(this.rotation)*d,this.vy=Math.sin(this.rotation)*d),this.segments.forEach(h=>{h.vx=0,h.vy=0}),this.resolveSegmentConstraints(),this.upgrades.forEach(h=>{h.update(t,i,e)})}resolveSegmentConstraints(){let t=this;for(let i=0;i<this.segments.length;i++){const e=this.segments[i],s=t.x-e.x,n=t.y-e.y,o=Math.sqrt(s*s+n*n);if(o!==0){const a=o-this.segmentSpacing,c=s/o*a,d=n/o*a;e.x+=c,e.y+=d}t=e}}render(t){this.upgrades.forEach(s=>s.render(t));for(let s=this.segments.length-1;s>=0;s--){const n=this.segments[s],o=this.radius;t.beginPath(),t.arc(n.x,n.y,o,0,Math.PI*2);const a=t.createRadialGradient(n.x-5,n.y-5,2,n.x,n.y,o);a.addColorStop(0,"#ebd5b3"),a.addColorStop(.5,"#b58d4a"),a.addColorStop(1,"#594326"),t.fillStyle=a,t.fill(),t.strokeStyle="#3d2e1e",t.lineWidth=2,t.stroke()}t.beginPath(),t.arc(this.x,this.y,this.radius,0,Math.PI*2);const i=t.createRadialGradient(this.x-5,this.y-5,2,this.x,this.y,this.radius);i.addColorStop(0,"#ffdf80"),i.addColorStop(.5,"#cfaa6e"),i.addColorStop(1,"#8c6a36"),t.fillStyle=i,t.fill(),t.strokeStyle="#594326",t.lineWidth=3,t.stroke();const e=25;t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+Math.cos(this.rotation)*e,this.y+Math.sin(this.rotation)*e),t.strokeStyle="#222",t.lineWidth=6,t.stroke(),t.beginPath(),t.moveTo(this.x,this.y),t.lineTo(this.x+Math.cos(this.rotation)*e,this.y+Math.sin(this.rotation)*e),t.strokeStyle="#434b4d",t.lineWidth=2,t.stroke()}}class w{bodies=[];world=null;constructor(){}setWorld(t){this.world=t}addBody(t){this.bodies.push(t)}removeBody(t){this.bodies=this.bodies.filter(i=>i!==t)}update(t){const i=r.getInstance().get("Physics","friction");for(const e of this.bodies){if(e.isStatic)continue;e.vx*=Math.pow(i,t*60),e.vy*=Math.pow(i,t*60);let s=e.x+e.vx*t,n=e.y+e.vy*t;if(this.world){const o=this.world.getWidthPixels(),a=this.world.getHeightPixels();if(this.world.isWall(s,e.y)&&(e.vx=0,this.world.isWall(e.x,e.y),s=e.x),this.world.isWall(s,n)&&(s=e.x,n=e.y,this.world.isWall(s,n))){const c=o/2,d=a/2,h=c-s,l=d-n,p=Math.sqrt(h*h+l*l)||1;s+=h/p*1,n+=l/p*1}s<e.radius&&(s=e.radius,e.vx=0),s>o-e.radius&&(s=o-e.radius,e.vx=0),n<e.radius&&(n=e.radius,e.vy=0),n>a-e.radius&&(n=a-e.radius,e.vy=0)}for(const o of this.bodies){if(e===o||o.isStatic)continue;const a=s-o.x,c=n-o.y,d=a*a+c*c,h=e.radius+o.radius;if(d<h*h&&d>0){const l=Math.sqrt(d),p=h-l,g=a/l,f=c/l;s+=g*p*.5,n+=f*p*.5}}e.x=s,e.y=n}}checkCollision(t,i){const e=t.x-i.x,s=t.y-i.y,n=e*e+s*s,o=t.radius+i.radius;return n<o*o}}class I{canvas;ctx;scanAngle=0;lastScanAngle=0;size=200;range=1e3;constructor(){this.canvas=document.createElement("canvas"),this.canvas.width=this.size,this.canvas.height=this.size,this.canvas.className="ui-radar",this.ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.bottom="20px",this.canvas.style.right="20px",this.canvas.style.borderRadius="50%",this.canvas.style.border="2px solid #00ff00",this.canvas.style.backgroundColor="rgba(0, 20, 0, 0.8)",document.getElementById("ui-layer")?.appendChild(this.canvas)}destroy(){this.canvas.remove()}update(t){this.lastScanAngle=this.scanAngle,this.scanAngle+=t*2,this.scanAngle>Math.PI*2&&(this.scanAngle-=Math.PI*2,this.lastScanAngle-=Math.PI*2)}render(t,i){this.ctx.clearRect(0,0,this.size,this.size);const e=this.size/2,s=this.size/2/this.range;this.ctx.strokeStyle="rgba(0, 255, 0, 0.3)",this.ctx.beginPath(),this.ctx.arc(e,e,this.size*.25,0,Math.PI*2),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.arc(e,e,this.size*.45,0,Math.PI*2),this.ctx.stroke();let n=!1;i.forEach(o=>{const a=o.x-t.x,c=o.y-t.y;if(Math.abs(a)>this.range||Math.abs(c)>this.range)return;const d=e+a*s,h=e+c*s;let l=Math.atan2(c,a);l<0&&(l+=Math.PI*2),l>=this.lastScanAngle&&l<this.scanAngle&&o!==t&&(n=!0);const p=o.constructor.name;o instanceof S?(this.ctx.fillStyle="#00ff00",this.ctx.beginPath(),this.ctx.arc(d,h,3,0,Math.PI*2),this.ctx.fill()):p==="Enemy"?(this.ctx.fillStyle="#ff0000",this.ctx.beginPath(),this.ctx.arc(d,h,3,0,Math.PI*2),this.ctx.fill()):p==="Projectile"&&(this.ctx.fillStyle="#ffff00",this.ctx.beginPath(),this.ctx.arc(d,h,2,0,Math.PI*2),this.ctx.fill())}),n&&y.getInstance().playSound("ping"),this.ctx.fillStyle="#fff",this.ctx.beginPath(),this.ctx.arc(e,e,2,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(e,e),this.ctx.lineTo(e+Math.cos(this.scanAngle)*(this.size/2),e+Math.sin(this.scanAngle)*(this.size/2)),this.ctx.strokeStyle="rgba(0, 255, 0, 0.8)",this.ctx.lineWidth=2,this.ctx.stroke()}}class C extends m{active=!0;lifeTime=2;speed=800;constructor(t,i,e){super(t,i),this.vx=Math.cos(e)*this.speed,this.vy=Math.sin(e)*this.speed,this.radius=4,this.color="#ffff00"}update(t){this.x+=this.vx*t,this.y+=this.vy*t,this.lifeTime-=t,this.lifeTime<=0&&(this.active=!1)}render(t){t.fillStyle=this.color,t.beginPath(),t.arc(this.x,this.y,this.radius,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 255, 0, 0.3)",t.beginPath(),t.arc(this.x-this.vx*.01,this.y-this.vy*.01,this.radius*.8,0,Math.PI*2),t.fill()}}class P extends m{health=20;active=!0;speed=150;constructor(t,i){super(t,i),this.color="#ff3333",this.radius=12}update(t,i){if(!i)return;const e=i.x-this.x,s=i.y-this.y,n=Math.sqrt(e*e+s*s);n>0&&(this.vx=e/n*this.speed,this.vy=s/n*this.speed,this.rotation=Math.atan2(s,e))}render(t){t.beginPath(),t.arc(this.x,this.y,this.radius,0,Math.PI*2);const i=t.createRadialGradient(this.x-3,this.y-3,1,this.x,this.y,this.radius);i.addColorStop(0,"#757575"),i.addColorStop(.6,"#434b4d"),i.addColorStop(1,"#2a2a2a"),t.fillStyle=i,t.fill(),t.strokeStyle="#222",t.stroke();const e=this.x+Math.cos(this.rotation)*6,s=this.y+Math.sin(this.rotation)*6;t.shadowBlur=10,t.shadowColor="#ff4500",t.fillStyle="#ff4500",t.beginPath(),t.arc(e,s,4,0,Math.PI*2),t.fill(),t.shadowBlur=0}takeDamage(t){this.health-=t,this.health<=0&&(this.active=!1)}}var v=(u=>(u.COIN="COIN",u.BOOSTER="BOOSTER",u.NEGATIVE="NEGATIVE",u))(v||{});class T extends m{type;active=!0;bobTime=Math.random()*Math.PI*2;constructor(t,i,e){switch(super(t,i),this.type=e,this.isStatic=!0,e){case"COIN":this.color="#ffd700",this.radius=8;break;case"BOOSTER":this.color="#00ffff",this.radius=10;break;case"NEGATIVE":this.color="#ff00ff",this.radius=10;break}}update(t){this.bobTime+=t*5}render(t){const i=Math.sin(this.bobTime)*5;if(t.shadowBlur=10,this.type==="COIN"){t.shadowColor="#ffd700",t.fillStyle="#cfaa6e",t.save(),t.translate(this.x,this.y+i),t.rotate(this.bobTime);const e=8,s=5,n=6;t.beginPath();for(let o=0;o<n*2;o++){const a=Math.PI*2*o/(n*2),c=o%2===0?e:s;t.lineTo(Math.cos(a)*c,Math.sin(a)*c)}t.closePath(),t.fill(),t.fillStyle="#000",t.beginPath(),t.arc(0,0,2,0,Math.PI*2),t.fill(),t.restore()}else t.shadowColor="#00ffff",t.fillStyle="#00ffff",t.beginPath(),t.arc(this.x,this.y+i,this.radius,0,Math.PI*2),t.fill();t.shadowBlur=0}}class k{constructor(t){this.parent=t}}class B extends k{fireTimer=0;range=300;fireRate=1;target=null;update(t,i,e){if(this.fireTimer+=t,(!this.target||!i.includes(this.target)||this.distTo(this.target)>this.range)&&(this.target=i.find(s=>this.distTo(s)<this.range)||null),this.target&&this.fireTimer>=1/this.fireRate){this.fireTimer=0;const s=Math.atan2(this.target.y-this.parent.y,this.target.x-this.parent.x);e(this.parent.x,this.parent.y,s)}}distTo(t){const i=t.x-this.parent.x,e=t.y-this.parent.y;return Math.sqrt(i*i+e*e)}shoot(){}render(t){t.strokeStyle="#434b4d",t.lineWidth=4,t.beginPath(),t.moveTo(this.parent.x,this.parent.y);const i=this.target?Math.atan2(this.target.y-this.parent.y,this.target.x-this.parent.x):0;t.lineTo(this.parent.x+Math.cos(i)*15,this.parent.y+Math.sin(i)*15),t.stroke()}}class D extends k{radius=40;strength=100;update(t,i,e){}render(t){t.strokeStyle="rgba(0, 255, 255, 0.4)",t.lineWidth=2,t.beginPath(),t.arc(this.parent.x,this.parent.y,this.radius,0,Math.PI*2),t.stroke(),t.fillStyle="rgba(0, 255, 255, 0.1)",t.fill()}}class O{constructor(t,i){this.sceneManager=t,this.inputManager=i,this.physics=new w}world=null;player=null;physics;radar=null;entities=[];enemies=[];drops=[];projectiles=[];lastShotTime=0;shootCooldown=.2;nextDropSpawn=5;nextEnemySpawn=3;coinsCollected=0;isDockOpen=!1;dockContainer=null;cameraX=0;cameraY=0;backButton=null;dockButton=null;onEnter(){this.world=new E,this.physics.setWorld(this.world);const t=this.world.getWidthPixels()/2,i=this.world.getHeightPixels()/2;this.player=new S(t,i,this.inputManager),this.entities.push(this.player),this.physics.addBody(this.player),this.player.getAllBodies().forEach(e=>{e!==this.player&&this.physics.addBody(e)}),this.radar=new I,this.shootCooldown=r.getInstance().get("Player","shootCooldown"),this.createUI()}onExit(){this.radar&&(this.radar.destroy(),this.radar=null),this.cleanupUI(),this.entities=[],this.enemies=[],this.drops=[],this.projectiles=[],this.physics=new w}createUI(){this.backButton=document.createElement("button"),this.backButton.textContent="MENU",this.backButton.className="hud-btn",this.backButton.style.position="absolute",this.backButton.style.top="10px",this.backButton.style.right="10px",this.backButton.addEventListener("click",()=>{this.sceneManager.switchScene("menu")}),document.body.appendChild(this.backButton),this.dockButton=document.createElement("button"),this.dockButton.textContent="DOCK (P)",this.dockButton.className="hud-btn",this.dockButton.style.position="absolute",this.dockButton.style.top="10px",this.dockButton.style.right="100px",this.dockButton.addEventListener("click",()=>{this.toggleDock()}),document.body.appendChild(this.dockButton)}cleanupUI(){this.backButton&&(this.backButton.remove(),this.backButton=null),this.dockButton&&(this.dockButton.remove(),this.dockButton=null),this.dockContainer&&(this.dockContainer.remove(),this.dockContainer=null)}toggleDock(){this.isDockOpen=!this.isDockOpen,this.isDockOpen?this.openDockUI():this.dockContainer&&(this.dockContainer.remove(),this.dockContainer=null)}openDockUI(){const t=document.getElementById("ui-layer");if(!t)return;this.dockContainer=document.createElement("div"),this.dockContainer.className="ui-panel",this.dockContainer.style.zIndex="2000";const i=r.getInstance().get("Upgrades","speedUpgradeCost"),e=r.getInstance().get("Upgrades","fireRateUpgradeCost"),s=r.getInstance().get("Upgrades","hullRepairCost");t.appendChild(this.dockContainer),this.updateDockContent(s,i,e)}updateDockContent(t,i,e){if(!this.dockContainer)return;const s=r.getInstance().get("Upgrades","slotUpgradeCost"),n=r.getInstance().get("Upgrades","turretUpgradeCost"),o=r.getInstance().get("Upgrades","shieldUpgradeCost");this.dockContainer.innerHTML=`
        <h2>ENGINEERING DOCK</h2>
        <p style="text-align: center; color: #cfaa6e; font-size: 1.2em;">COINS: ${this.coinsCollected}</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <button id="buy-repair" ${this.coinsCollected<t?'disabled style="opacity:0.5"':""}>Repair Hull (${t})</button>
            <button id="buy-speed" ${this.coinsCollected<i?'disabled style="opacity:0.5"':""}>Engine Tune (${i})</button>
            <button id="buy-fire" ${this.coinsCollected<e?'disabled style="opacity:0.5"':""}>Weapon Sys (${e})</button>
            <button id="buy-slot" ${this.coinsCollected<s?'disabled style="opacity:0.5"':""}>New Slot (${s})</button>
            <button id="buy-turret" ${this.coinsCollected<n?'disabled style="opacity:0.5"':""}>Equip Turret (${n})</button>
            <button id="buy-shield" ${this.coinsCollected<o?'disabled style="opacity:0.5"':""}>Equip Shield (${o})</button>
        </div>
        <button id="btn-close-dock" style="margin-top: 20px; background: #594326;">CLOSE DOCK</button>
      `,this.dockContainer.querySelector("#buy-repair")?.addEventListener("click",()=>{this.coinsCollected>=t&&(this.coinsCollected-=t,this.updateDockContent(t,i,e))}),this.dockContainer.querySelector("#buy-speed")?.addEventListener("click",()=>{if(this.coinsCollected>=i){this.coinsCollected-=i;const a=r.getInstance().get("Player","baseSpeed");r.getInstance().set("Player","baseSpeed",a+1),this.player&&this.player.refreshConfig(),this.updateDockContent(t,i,e)}}),this.dockContainer.querySelector("#buy-fire")?.addEventListener("click",()=>{if(this.coinsCollected>=e){this.coinsCollected-=e;const a=r.getInstance().get("Player","shootCooldown");r.getInstance().set("Player","shootCooldown",Math.max(.05,a-.02)),this.shootCooldown=r.getInstance().get("Player","shootCooldown"),this.updateDockContent(t,i,e)}}),this.dockContainer.querySelector("#buy-slot")?.addEventListener("click",()=>{if(this.coinsCollected>=s&&this.player){this.coinsCollected-=s,this.player.addSlot();const a=this.player.getAllBodies();this.physics.addBody(a[a.length-1]),this.updateDockContent(t,i,e)}}),this.dockContainer.querySelector("#buy-turret")?.addEventListener("click",()=>{if(this.coinsCollected>=n&&this.player){const a=this.findFreeSlot();if(a!==-1){this.coinsCollected-=n;const c=this.player.segments[a];this.player.upgrades.set(a,new B(c)),this.updateDockContent(t,i,e)}else alert("NO FREE SLOTS!")}}),this.dockContainer.querySelector("#buy-shield")?.addEventListener("click",()=>{if(this.coinsCollected>=o&&this.player){const a=this.findFreeSlot();if(a!==-1){this.coinsCollected-=o;const c=this.player.segments[a];this.player.upgrades.set(a,new D(c)),this.updateDockContent(t,i,e)}else alert("NO FREE SLOTS!")}}),this.dockContainer.querySelector("#btn-close-dock")?.addEventListener("click",()=>{this.toggleDock()})}findFreeSlot(){if(!this.player)return-1;for(let t=0;t<this.player.segments.length;t++)if(!this.player.upgrades.has(t))return t;return-1}update(t){if(this.inputManager.isKeyDown("Escape")){this.sceneManager.switchScene("menu");return}const i=r.getInstance().get("Keybindings","openDock");if(this.inputManager.isKeyJustPressed(i)&&this.toggleDock(),!this.isDockOpen){if(this.physics.update(t),this.nextDropSpawn-=t,this.nextDropSpawn<=0&&(this.spawnDrop(),this.nextDropSpawn=5+Math.random()*10),this.nextEnemySpawn-=t,this.nextEnemySpawn<=0&&(this.spawnEnemy(),this.nextEnemySpawn=4+Math.random()*4),this.inputManager.isKeyDown("Space")&&this.player){const e=performance.now()/1e3;if(e-this.lastShotTime>this.shootCooldown){this.lastShotTime=e;const s=new C(this.player.x,this.player.y,this.player.rotation);this.projectiles.push(s)}}if(this.player){for(const e of this.projectiles){if(this.world){const s=this.world.getWidthPixels(),n=this.world.getHeightPixels();(this.world.isWall(e.x,e.y)||e.x<0||e.x>s||e.y<0||e.y>n)&&(e.active=!1)}for(const s of this.enemies)this.physics.checkCollision(e,s)&&(s.takeDamage(10),e.active=!1)}for(const e of this.drops)this.physics.checkCollision(this.player,e)&&(e.active=!1,e.type===v.COIN&&(this.coinsCollected+=10))}if(this.entities.forEach(e=>{e instanceof S?e.update(t,this.enemies,(s,n,o)=>{this.projectiles.push(new C(s,n,o))}):e.update(t)}),this.enemies.forEach(e=>e.update(t,this.player||void 0)),this.drops.forEach(e=>e.update(t)),this.projectiles=this.projectiles.filter(e=>(e.update(t),e.active)),this.enemies=this.enemies.filter(e=>(e.active||this.physics.removeBody(e),e.active)),this.drops=this.drops.filter(e=>e.active),this.player){const e=window.innerWidth,s=window.innerHeight;this.cameraX=this.player.x-e/2,this.cameraY=this.player.y-s/2}this.radar&&this.player&&this.radar.update(t)}}render(t){if(t.fillStyle="#000",t.fillRect(0,0,t.canvas.width,t.canvas.height),!this.world||!this.player)return;t.save(),t.translate(-this.cameraX,-this.cameraY),this.world.render(t,this.cameraX,this.cameraY),this.drops.forEach(e=>e.render(t)),this.player.render(t);const i=r.getInstance().get("World","renderDistance")*r.getInstance().get("World","tileSize");if(this.enemies.forEach(e=>{const s=e.x-this.player.x,n=e.y-this.player.y;Math.abs(s)<i&&Math.abs(n)<i&&e.render(t)}),this.projectiles.forEach(e=>e.render(t)),t.restore(),this.radar){const e=[this.player,...this.enemies,...this.projectiles];this.radar.render(this.player,e)}t.fillStyle="#fff",t.font="14px Courier",t.fillText(`POS: ${Math.floor(this.player.x)}, ${Math.floor(this.player.y)}`,10,20),t.fillText(`COINS: ${this.coinsCollected}`,10,40)}spawnDrop(){if(!this.world)return;const t=this.getRandomValidPos(),i=Math.random()<.8?v.COIN:v.BOOSTER,e=new T(t.x,t.y,i);this.drops.push(e)}spawnEnemy(){if(!this.world||!this.player)return;let t=0;for(;t<10;){const i=Math.random()*Math.PI*2,e=400+Math.random()*400,s=this.player.x+Math.cos(i)*e,n=this.player.y+Math.sin(i)*e;if(!this.world.isWall(s,n)){const o=new P(s,n);this.enemies.push(o),this.physics.addBody(o);break}t++}}getRandomValidPos(){if(!this.world)return{x:0,y:0};let t=0;for(;t<20;){const i=Math.random()*this.world.getWidthPixels(),e=Math.random()*this.world.getHeightPixels();if(!this.world.isWall(i,e))return{x:i,y:e};t++}return{x:100,y:100}}}class L{constructor(t,i,e){this.ctx=t,this.uiLayer=i,this.inputManager=e,this.scenes.set("menu",new M(this)),this.scenes.set("settings",new x(this)),this.scenes.set("gameplay",new O(this,e)),this.switchScene("menu")}scenes=new Map;currentScene=null;switchScene(t){this.currentScene&&this.currentScene.onExit();const i=this.scenes.get(t);i?(this.currentScene=i,this.currentScene.onEnter()):console.error(`Scene ${t} not found!`)}update(t){this.currentScene&&this.currentScene.update(t)}render(){this.currentScene&&this.currentScene.render(this.ctx)}}class W{keys=new Set;prevKeys=new Set;x=0;y=0;mouseX=0;mouseY=0;constructor(){window.addEventListener("keydown",t=>this.onKeyDown(t)),window.addEventListener("keyup",t=>this.onKeyUp(t)),window.addEventListener("mousemove",t=>this.onMouseMove(t))}update(){this.prevKeys=new Set(this.keys)}onMouseMove(t){this.mouseX=t.clientX,this.mouseY=t.clientY}onKeyDown(t){this.keys.add(t.code),this.updateDirection()}onKeyUp(t){this.keys.delete(t.code),this.updateDirection()}updateDirection(){this.x=0,this.y=0,(this.keys.has("KeyW")||this.keys.has("ArrowUp"))&&(this.y-=1),(this.keys.has("KeyS")||this.keys.has("ArrowDown"))&&(this.y+=1),(this.keys.has("KeyA")||this.keys.has("ArrowLeft"))&&(this.x-=1),(this.keys.has("KeyD")||this.keys.has("ArrowRight"))&&(this.x+=1)}isKeyDown(t){return this.keys.has(t)}isKeyJustPressed(t){return this.keys.has(t)&&!this.prevKeys.has(t)}}class ${canvas;ctx;lastTime=0;sceneManager;inputManager;constructor(t){const i=document.getElementById(t);if(!i)throw new Error(`Container ${t} not found`);this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),i.appendChild(this.canvas);const e=document.createElement("div");e.id="ui-layer",i.appendChild(e),this.inputManager=new W,this.sceneManager=new L(this.ctx,e,this.inputManager),window.addEventListener("resize",()=>this.resize()),this.resize(),requestAnimationFrame(s=>this.loop(s))}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight}loop(t){const i=(t-this.lastTime)/1e3;this.lastTime=t,this.update(i),this.render(),requestAnimationFrame(e=>this.loop(e))}update(t){this.sceneManager.update(t),this.inputManager.update()}render(){this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.sceneManager.render()}}window.addEventListener("DOMContentLoaded",()=>{new $("app")});
